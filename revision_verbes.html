<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Verbes Espagnol LÃ©onard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <a href="index.html" class="back-btn">Retour</a>
    <div class="navbar"><div class="navbar-content"><h1>ES - Quiz Verbes</h1></div></div>
    <div class="container">
        <div class="header-section">
            <div class="score-display"><span id="scoreValue">0</span>/<span id="maxQuestions">10</span></div>
            <div class="header-result" id="headerResult" style="display: none;"><div class="header-result-text" id="headerResultText"></div></div>
            <div class="settings-section">
                <label>Questions:</label><select id="numQuestions" onchange="changerNombreQuestions()"><option value="10" selected>10</option><option value="20">20</option><option value="30">30</option></select>
            </div>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div id="gameContainer">
            <div class="card-vocabulary">
                <div class="word-label" id="wordLabel">Conjugue le verbe:</div>
                <div class="word-display" id="wordDisplay">Chargement...</div>
                <div class="pronoun-display" id="pronounDisplay"></div>
                <div class="verb-info" id="verbInfo"></div>
                <button class="listen-btn" id="listenBtn" onclick="ecouterVerbe()" style="margin-top: 15px;">ðŸ”Š Ã‰couter</button>
            </div>
            <div class="quiz-options" id="quizOptions"></div>
        </div>
        <div id="gameOverContainer" style="display: none;"><div class="game-over"><h2>Quiz terminÃ©!</h2><div class="final-score">Score: <span id="finalScore">0</span>/<span id="finalMax">10</span></div><div style="font-size: 1.5em; color: #26D07C; margin-bottom: 30px;"><span id="percentageValue">0</span>%</div><div id="bonusMessage" style="display: none; color: #FFB800; font-size: 1.2em; margin: 20px 0; font-weight: bold;">ðŸŽ® Parfait! Question bonus Valorant ðŸŽ®</div><button class="btn btn-primary" onclick="recommencer()">Recommencer</button></div></div>
        <div id="bonusContainer" style="display: none;">
            <div class="card-vocabulary">
                <img id="bonusPhoto" src="" alt="Joueur" style="width: 200px; height: 200px; object-fit: cover; border-radius: 10px; margin-bottom: 15px;">
                <div class="word-display" id="bonusNickname" style="font-size: 1.3em;">Joueur</div>
                <div class="word-label" id="bonusQuestion" style="margin-top: 20px;">Question</div>
            </div>
            <div class="quiz-options" id="bonusOptions"></div>
        </div>
    </div>
    <script>
        let verbesList = [];
        let valorantPlayers = [];
        let verbeActuel = null;
        let pronounActuel = null;
        let score = 0;
        let totalQuestions = 0;
        let maxQuestions = 10;
        let bonusAnswer = null;
        let bonusPlayer = null;
        let bonusQuestionType = null;
        
        const pronouns = {
            "yo": "je",
            "tu": "tu",
            "el": "il/elle/vous",
            "nosotros": "nous",
            "vosotros": "vous (Espagne)",
            "ellos": "ils/elles"
        };
        
        async function chargerVerbes() {
            try {
                const res = await fetch('present.json?t=' + Date.now());
                const data = await res.json();
                verbesList = data.verbes_present;
                chargerValorant();
            } catch(e) {
                console.error('Erreur:', e);
                document.getElementById('wordDisplay').textContent = 'Erreur chargement';
            }
        }
        
        async function chargerValorant() {
            try {
                const res = await fetch('valorant.json?t=' + Date.now());
                const data = await res.json();
                valorantPlayers = [
                    ...data.Americas,
                    ...data.EMEA,
                    ...data.Pacific
                ];
                nouvelVerbe();
            } catch(e) {
                console.error('Erreur Valorant:', e);
                nouvelVerbe();
            }
        }
        
        function ecouterVerbe() {
            if (!verbeActuel) return;
            const synthÃ¨se = window.speechSynthesis;
            synthÃ¨se.cancel();
            
            const formeConjuguee = verbeActuel.conjugaison[pronounActuel];
            const utterance = new SpeechSynthesisUtterance(formeConjuguee);
            utterance.lang = 'es-ES';
            utterance.rate = 0.9;
            synthÃ¨se.speak(utterance);
        }
        
        function changerNombreQuestions() {
            maxQuestions = parseInt(document.getElementById('numQuestions').value);
            document.getElementById('maxQuestions').textContent = maxQuestions;
            reinitialiserQuiz();
        }
        
        function reinitialiserQuiz() {
            score = 0;
            totalQuestions = 0;
            document.getElementById('scoreValue').textContent = '0';
            document.getElementById('gameContainer').style.display = 'block';
            document.getElementById('gameOverContainer').style.display = 'none';
            document.getElementById('bonusContainer').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
            nouvelVerbe();
        }
        
        function nouvelVerbe() {
            if (totalQuestions >= maxQuestions) {
                document.getElementById('finalScore').textContent = score;
                document.getElementById('finalMax').textContent = maxQuestions;
                const pct = Math.round((score / maxQuestions) * 100);
                document.getElementById('percentageValue').textContent = pct;
                
                // Si score parfait et joueurs disponibles
                if (pct === 100 && valorantPlayers.length > 0) {
                    genererBonusValorant();
                    return;
                }
                
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('gameOverContainer').style.display = 'block';
                return;
            }
            
            const idxVerbe = Math.floor(Math.random() * verbesList.length);
            verbeActuel = verbesList[idxVerbe];
            
            const pronounKeys = Object.keys(verbeActuel.conjugaison);
            pronounActuel = pronounKeys[Math.floor(Math.random() * pronounKeys.length)];
            
            const bonneReponse = verbeActuel.conjugaison[pronounActuel];
            const traductionPronom = pronouns[pronounActuel];
            
            document.getElementById('wordLabel').textContent = 'Conjugue le verbe:';
            document.getElementById('wordDisplay').textContent = verbeActuel.infinitif;
            document.getElementById('pronounDisplay').textContent = `(${traductionPronom})`;
            document.getElementById('verbInfo').textContent = `${verbeActuel.traduction} - Type: ${verbeActuel.type}`;
            document.getElementById('headerResult').style.display = 'none';
            
            let options = [bonneReponse];
            
            const autrePronounKeys = pronounKeys.filter(p => p !== pronounActuel);
            while (options.length < 3 && autrePronounKeys.length > 0) {
                const idx = Math.floor(Math.random() * autrePronounKeys.length);
                const wrongPronom = autrePronounKeys[idx];
                const wrongOption = verbeActuel.conjugaison[wrongPronom];
                if (!options.includes(wrongOption)) {
                    options.push(wrongOption);
                    autrePronounKeys.splice(idx, 1);
                }
            }
            
            while (options.length < 4) {
                const idxAutreVerbe = Math.floor(Math.random() * verbesList.length);
                const autreVerbe = verbesList[idxAutreVerbe];
                const autrePronom = Object.keys(autreVerbe.conjugaison)[Math.floor(Math.random() * 6)];
                const option = autreVerbe.conjugaison[autrePronom];
                if (!options.includes(option)) {
                    options.push(option);
                }
            }
            
            options = options.sort(() => Math.random() - 0.5);
            
            const container = document.getElementById('quizOptions');
            container.innerHTML = '';
            
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt;
                btn.onclick = () => {
                    totalQuestions++;
                    const correct = opt === bonneReponse;
                    if (correct) {
                        score++;
                        document.getElementById('scoreValue').textContent = score;
                        btn.classList.add('correct');
                        document.getElementById('headerResultText').innerHTML = 'Correct!';
                        document.getElementById('headerResultText').className = 'header-result-text correct';
                    } else {
                        btn.classList.add('incorrect');
                        document.getElementById('headerResultText').innerHTML = 'Incorrect';
                        document.getElementById('headerResultText').className = 'header-result-text incorrect';
                    }
                    document.getElementById('progressFill').style.width = ((totalQuestions / maxQuestions) * 100) + '%';
                    document.getElementById('headerResult').style.display = 'flex';
                    document.querySelectorAll('.option-btn').forEach(b => {
                        b.disabled = true;
                        if (b.textContent === bonneReponse) b.classList.add('correct');
                    });
                    setTimeout(() => nouvelVerbe(), 1500);
                };
                container.appendChild(btn);
            });
        }
        
        function genererBonusValorant() {
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('gameOverContainer').style.display = 'block';
            document.getElementById('bonusMessage').style.display = 'block';
            
            // SÃ©lectionner un joueur alÃ©atoire
            bonusPlayer = valorantPlayers[Math.floor(Math.random() * valorantPlayers.length)];
            
            // SÃ©lectionner le type de question
            const types = ['role', 'nationality', 'team', 'first_name', 'last_name'];
            bonusQuestionType = types[Math.floor(Math.random() * types.length)];
            
            // DÃ©terminer la bonne rÃ©ponse et la question
            const questionsES = {
                'role': 'Â¿CuÃ¡l es su rol en el equipo?',
                'nationality': 'Â¿De quÃ© paÃ­s es?',
                'team': 'Â¿CuÃ¡l es su equipo?',
                'first_name': 'Â¿CuÃ¡l es su nombre de pila?',
                'last_name': 'Â¿CuÃ¡l es su apellido?'
            };
            
            bonusAnswer = bonusPlayer[bonusQuestionType];
            
            // Afficher la photo et le nickname
            document.getElementById('bonusPhoto').src = bonusPlayer.photo;
            document.getElementById('bonusNickname').textContent = bonusPlayer.nickname;
            document.getElementById('bonusQuestion').textContent = questionsES[bonusQuestionType];
            
            // GÃ©nÃ©rer les options
            let options = [bonusAnswer];
            
            const otherPlayers = valorantPlayers.filter(p => p.nickname !== bonusPlayer.nickname);
            while (options.length < 4 && otherPlayers.length > 0) {
                const randomOther = otherPlayers[Math.floor(Math.random() * otherPlayers.length)];
                const option = randomOther[bonusQuestionType];
                if (!options.includes(option)) {
                    options.push(option);
                }
            }
            
            options = options.sort(() => Math.random() - 0.5);
            
            const container = document.getElementById('bonusOptions');
            container.innerHTML = '';
            
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt;
                btn.onclick = () => {
                    const correct = opt === bonusAnswer;
                    if (correct) {
                        btn.classList.add('correct');
                    } else {
                        btn.classList.add('incorrect');
                    }
                    document.querySelectorAll('#bonusOptions .option-btn').forEach(b => {
                        b.disabled = true;
                        if (b.textContent === bonusAnswer) b.classList.add('correct');
                    });
                    setTimeout(() => {
                        document.getElementById('bonusContainer').style.display = 'none';
                        document.getElementById('gameOverContainer').style.display = 'block';
                    }, 1500);
                };
                container.appendChild(btn);
            });
            
            document.getElementById('bonusContainer').style.display = 'block';
        }
        
        function recommencer() {
            reinitialiserQuiz();
        }
        
        window.addEventListener('load', () => chargerVerbes());
    </script>
</body>
</html>
